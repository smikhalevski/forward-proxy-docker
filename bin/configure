#!/bin/sh

PID_FILE=/tmp/tinyproxy.pid
PORT=65050
BASIC_AUTH=''
ALLOW=''

echo
echo '1/2 Configure authentication'
read -p '    Username: ' USERNAME

[ "$USERNAME" ] && read -p '    Password: ' PASSWORD

[ "$PASSWORD" ] && BASIC_AUTH="BasicAuth ${USERNAME} ${PASSWORD}"

[ "$BASIC_AUTH" ] || echo '    Authentication disabled'

echo
if [[ "$(read -p '2/2 Enable IP whitelist? [y/n]: ' YES && echo $YES)" == [yY] ]]; then
    while true; do
        read -p '    Enter an IP address: ' IP
        [ -z "$IP" ] && break
        ALLOW=$(echo -e "${ALLOW}\nAllow ${IP}")
    done
fi

mkdir -p /etc/tinyproxy

cat >/etc/tinyproxy/tinyproxy.conf <<EOF
User nobody
Group nogroup
PidFile "${PID_FILE}"
Port ${PORT}
Listen 0.0.0.0
Timeout 600
MaxClients 256
DisableViaHeader Yes
${BASIC_AUTH}
${ALLOW}
EOF

echo
echo 'Starting server...'

while [ ! -f "$PID_FILE" ]; do
    sleep 2
done

PUBLIC_IP_ADDR=$(wget -qO- http://myip.enix.org/REMOTE_ADDR)

echo
echo -e "Server started successfully: \033[0;32m${PUBLIC_IP_ADDR}:${PORT}\033[0m"
